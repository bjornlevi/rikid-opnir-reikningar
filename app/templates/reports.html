<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Opnir reikningar - Reports</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body>
    <header>
      <h1>Opnir reikningar</h1>
      <p class="subtitle">Reports: flip between Kaupandi and Tegund views</p>
      <nav class="top-nav">
        <a href="{{ url_for('index') }}">Explorer</a>
        <a href="{{ url_for('reports') }}" class="active">Reports</a>
      </nav>
    </header>

    {% if not data_loaded %}
      <section class="notice"><p>{{ error }}</p></section>
    {% else %}
      {% if selected_tegund %}
        <section class="notice">
          <p>Selected tegund: <strong>{{ selected_tegund }}</strong></p>
        </section>
      {% endif %}
      <div class="container">
        <aside class="panel">
          <div class="section-title">Mode</div>
          <div class="pill-grid">
            <a class="pill {% if mode == 'by_kaupandi' %}active{% endif %}" href="{{ build_reports_url(base_params, mode='by_kaupandi') }}">By kaupandi</a>
            <a class="pill {% if mode == 'by_tegund' %}active{% endif %}" href="{{ build_reports_url(base_params, mode='by_tegund') }}">By tegund</a>
          </div>

          {% if mode == 'by_kaupandi' %}
            <div class="section-title">Kaupandi</div>
            <div class="pill-grid">
              <a class="pill {% if not buyer %}active{% endif %}" href="{{ build_reports_url(base_params, buyer='') }}">All</a>
              {% for row in buyer_rows[:120] %}
                <a class="pill {% if row['buyer'] == buyer %}active{% endif %}" href="{{ build_reports_url(base_params, buyer=row['buyer']) }}">
                  {{ row['buyer'] }}
                </a>
              {% endfor %}
            </div>
          {% else %}
            <div class="section-title">Tegund</div>
            <div class="pill-grid">
              <a class="pill {% if not selected_tegund %}active{% endif %}" href="{{ build_reports_url(base_params, tegund='') }}">All</a>
              {% for row in tegund_options[:120] %}
                <a class="pill {% if row['tegund'] == selected_tegund %}active{% endif %}" href="{{ build_reports_url(base_params, tegund=row['tegund']) }}">
                  {{ row['tegund'] }}
                </a>
              {% endfor %}
            </div>
          {% endif %}
        </aside>

        <section class="panel">
          <div class="section-title">Scope</div>
          <p>{{ scope_label }}</p>

          <div class="section-title">Year filter (totals table)</div>
          <div class="pill-grid">
            {% for y in report_year_links %}
              <a class="pill {% if y == report_year %}active{% endif %}" href="{{ build_reports_url(base_params, report_year=y) }}">
                {{ 'All' if y == 'all' else y }}
              </a>
            {% endfor %}
          </div>

          <div class="section-title">Development by year</div>
          {% if yearly_rows %}
            <div class="chart-wrap"><canvas id="yearlyChart" class="chart"></canvas></div>
          {% else %}
            <div class="notice">No yearly data for this scope.</div>
          {% endif %}

          <div class="section-title">{{ totals_title }}</div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>{{ totals_first_col }}</th>
                  <th class="num">Total sum</th>
                  <th class="num">Positive sum</th>
                  <th class="num">Negative sum</th>
                  <th class="num">Rows</th>
                </tr>
              </thead>
              <tbody>
                {% for row in totals_rows %}
                  <tr>
                    <td>
                      {% if mode == 'by_kaupandi' %}
                        <a href="{{ build_reports_url(base_params, tegund=('' if selected_tegund == row['group_label'] else row['group_label'])) }}">{{ row['group_label'] }}</a>
                      {% else %}
                        <a href="{{ build_reports_url(base_params, buyer=('' if buyer == row['group_label'] else row['group_label'])) }}">{{ row['group_label'] }}</a>
                      {% endif %}
                    </td>
                    <td class="num">{{ row['total_sum_fmt'] }}</td>
                    <td class="num">{{ row['positive_sum_fmt'] }}</td>
                    <td class="num">{{ row['negative_sum_fmt'] }}</td>
                    <td class="num">{{ row['row_count'] }}</td>
                  </tr>
                {% endfor %}
              </tbody>
              <tfoot>
                <tr>
                  <td>Total</td>
                  <td class="num">{{ totals_total_row['total_sum_fmt'] }}</td>
                  <td class="num">{{ totals_total_row['positive_sum_fmt'] }}</td>
                  <td class="num">{{ totals_total_row['negative_sum_fmt'] }}</td>
                  <td class="num">{{ totals_total_row['row_count'] }}</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </section>
      </div>
    {% endif %}

    {% if data_loaded and yearly_rows %}
      <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
      <script>
        new Chart(document.getElementById("yearlyChart"), {
          type: "line",
          data: {
            labels: {{ yearly_labels_json | safe }},
            datasets: {{ chart_datasets_json | safe }},
          },
          options: {
            maintainAspectRatio: false,
            interaction: { mode: "index", intersect: false },
            plugins: { legend: { position: "bottom" } },
          },
        });
      </script>
    {% endif %}
  </body>
</html>
