<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Opnir reikningar - Reports</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body>
    <header>
      <h1>Opnir reikningar</h1>
      <p class="subtitle">Reports: flip between Kaupandi and Tegund views</p>
      <nav class="top-nav">
        <a href="{{ url_for('index') }}">Explorer</a>
        <a href="{{ url_for('analysis') }}">Analysis</a>
        <a href="{{ url_for('anomalies') }}">Anomalies</a>
        <a href="{{ url_for('reports') }}" class="active">Reports</a>
      </nav>
    </header>

    {% if not data_loaded %}
      <section class="notice"><p>{{ error }}</p></section>
    {% else %}
      {% if selected_tegund %}
        <section class="notice">
          <p>Selected tegund: <strong>{{ selected_tegund_display }}</strong></p>
        </section>
      {% endif %}
      <div class="container">
        <aside class="panel">
          <form method="get" action="{{ url_for('reports') }}" class="stack-form">
            <label for="mode">Mode</label>
            <select id="mode" name="mode">
              <option value="by_kaupandi" {% if mode == 'by_kaupandi' %}selected{% endif %}>By kaupandi</option>
              <option value="by_tegund" {% if mode == 'by_tegund' %}selected{% endif %}>By tegund</option>
            </select>

            {% if mode == 'by_kaupandi' %}
              <label for="buyer">Kaupandi</label>
              <select id="buyer" name="buyer">
                <option value="" {% if not buyer %}selected{% endif %}>All</option>
                {% for row in buyer_rows %}
                  <option value="{{ row['buyer'] }}" {% if row['buyer'] == buyer %}selected{% endif %}>{{ row['buyer_display'] }}</option>
                {% endfor %}
              </select>
              <input type="hidden" name="tegund" value="{{ selected_tegund }}" />
            {% else %}
              <label for="tegund">Tegund</label>
              <select id="tegund" name="tegund">
                <option value="" {% if not selected_tegund %}selected{% endif %}>All</option>
                {% for row in tegund_options %}
                  <option value="{{ row['tegund'] }}" {% if row['tegund'] == selected_tegund %}selected{% endif %}>{{ row['tegund_display'] }}</option>
                {% endfor %}
              </select>
              <input type="hidden" name="buyer" value="{{ buyer }}" />
            {% endif %}

            <label for="report_year">Year (totals table)</label>
            <select id="report_year" name="report_year">
              {% for y in report_year_links %}
                <option value="{{ y }}" {% if y == report_year %}selected{% endif %}>{{ 'All' if y == 'all' else y }}</option>
              {% endfor %}
            </select>

            <button type="submit">Apply</button>
          </form>
        </aside>

        <section class="panel">
          <div class="section-title">Scope</div>
          <p>{{ scope_label }}</p>

          <div class="section-title">Development by year</div>
          {% if yearly_rows %}
            <div class="chart-wrap"><canvas id="yearlyChart" class="chart"></canvas></div>
          {% else %}
            <div class="notice">No yearly data for this scope.</div>
          {% endif %}

          <div class="section-title">{{ totals_title }}</div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>{{ totals_first_col }}</th>
                  <th class="num">Total sum</th>
                  <th class="num">Positive sum</th>
                  <th class="num">Negative sum</th>
                  <th class="num">Rows</th>
                </tr>
              </thead>
              <tbody>
                {% for row in totals_rows %}
                  <tr>
                    <td>
                      {% if mode == 'by_kaupandi' %}
                        <a href="{{ build_reports_url(base_params, tegund=('' if selected_tegund == row['group_label'] else row['group_label'])) }}">{{ row['group_label_display'] }}</a>
                      {% else %}
                        <a href="{{ build_reports_url(base_params, buyer=('' if buyer == row['group_label'] else row['group_label'])) }}">{{ row['group_label_display'] }}</a>
                      {% endif %}
                    </td>
                    <td class="num">{{ row['total_sum_fmt'] }}</td>
                    <td class="num">{{ row['positive_sum_fmt'] }}</td>
                    <td class="num">{{ row['negative_sum_fmt'] }}</td>
                    <td class="num">{{ row['row_count'] }}</td>
                  </tr>
                {% endfor %}
              </tbody>
              <tfoot>
                <tr>
                  <td>Total</td>
                  <td class="num">{{ totals_total_row['total_sum_fmt'] }}</td>
                  <td class="num">{{ totals_total_row['positive_sum_fmt'] }}</td>
                  <td class="num">{{ totals_total_row['negative_sum_fmt'] }}</td>
                  <td class="num">{{ totals_total_row['row_count'] }}</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </section>
      </div>
    {% endif %}

    {% if data_loaded and yearly_rows %}
      <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
      <script>
        new Chart(document.getElementById("yearlyChart"), {
          type: "line",
          data: {
            labels: {{ yearly_labels_json | safe }},
            datasets: {{ chart_datasets_json | safe }},
          },
          options: {
            maintainAspectRatio: false,
            interaction: { mode: "index", intersect: false },
            plugins: { legend: { position: "bottom" } },
          },
        });
      </script>
    {% endif %}
  </body>
</html>
